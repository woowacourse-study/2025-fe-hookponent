name: PR Test

on:
  pull_request:
    branches:
      - dev

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ---------------------------
      # Type Check
      # ---------------------------
      - name: Run type check
        id: typecheck
        run: |
          echo "## ğŸ” Type Check" >> test_results.md
          if npm run typecheck > typecheck.log 2>&1; then
            echo "âœ… Type check passed" >> test_results.md
            echo "typecheck_status=âœ… ì„±ê³µ" >> $GITHUB_OUTPUT
            echo "typecheck_result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Type check failed" >> test_results.md
            echo "### âŒ ì—ëŸ¬ ë¡œê·¸ (ë§ˆì§€ë§‰ 20ì¤„)" >> test_results.md
            tail -n 20 typecheck.log >> test_results.md
            echo "typecheck_status=âŒ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
            echo "typecheck_result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      # ---------------------------
      # Lint
      # ---------------------------
      - name: Run lint
        id: lint
        if: steps.typecheck.outputs.typecheck_result == 'success'
        run: |
          echo "" >> test_results.md
          echo "## ğŸ“ Lint Check" >> test_results.md
          if npm run lint > lint.log 2>&1; then
            echo "âœ… Lint check passed" >> test_results.md
            echo "lint_status=âœ… ì„±ê³µ" >> $GITHUB_OUTPUT
            echo "lint_result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Lint check failed" >> test_results.md
            echo "### âŒ ì—ëŸ¬ ë¡œê·¸ (ë§ˆì§€ë§‰ 20ì¤„)" >> test_results.md
            tail -n 20 lint.log >> test_results.md
            echo "lint_status=âŒ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
            echo "lint_result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      # ---------------------------
      # Tests
      # ---------------------------
      - name: Run test
        id: test
        if: steps.lint.outputs.lint_result == 'success'
        run: |
          echo "" >> test_results.md
          echo "## ğŸ§ª Tests" >> test_results.md
          if npm run test:hookdle && npm run test:componentdle > test.log 2>&1; then
            echo "âœ… Tests passed" >> test_results.md
            echo "test_status=âœ… ì„±ê³µ" >> $GITHUB_OUTPUT
            echo "test_result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tests failed" >> test_results.md
            echo "### âŒ ì—ëŸ¬ ë¡œê·¸ (ë§ˆì§€ë§‰ 20ì¤„)" >> test_results.md
            tail -n 20 test.log >> test_results.md
            echo "test_status=âŒ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
            echo "test_result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      # ---------------------------
      # í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
      # ---------------------------
      - name: Get current time
        uses: josStorer/get-current-time@v2
        id: current-time
        if: always()
        with:
          format: 'YYYYë…„ MMì›” DDì¼ HHì‹œ mmë¶„ ssì´ˆ'
          utcOffset: '+09:00'

      # ---------------------------
      # ìŠ¤í‚µëœ ë‹¨ê³„ ìƒíƒœ í‘œì‹œ
      # ---------------------------
      - name: Set skipped statuses
        if: always()
        run: |
          if [[ "${{ steps.typecheck.outputs.typecheck_result }}" != "success" ]]; then
            echo "lint_status=â­ï¸ ê±´ë„ˆëœ€" >> $GITHUB_OUTPUT
            echo "test_status=â­ï¸ ê±´ë„ˆëœ€" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.lint.outputs.lint_result }}" != "success" ]]; then
            echo "test_status=â­ï¸ ê±´ë„ˆëœ€" >> $GITHUB_OUTPUT
          fi
        id: skipped

      # ---------------------------
      # í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ ì½ê¸°
      # ---------------------------
      - name: Read test results
        if: always()
        id: read-results
        run: |
          if [ -f test_results.md ]; then
            {
              echo 'test_results_content<<EOF'
              cat test_results.md
              echo EOF
            } >> $GITHUB_OUTPUT
          else
            echo 'test_results_content=í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' >> $GITHUB_OUTPUT
          fi

      # ---------------------------
      # PR ì½”ë©˜íŠ¸ ì‘ì„±
      # ---------------------------
      - name: Comment PR with test results
        uses: thollander/actions-comment-pull-request@v2
        if: always()
        with:
          comment_tag: ${{ github.event.number }}-test-results
          message: |
            ## ğŸš€ í…ŒìŠ¤íŠ¸ ê²°ê³¼

            **ì‹¤í–‰ ì‹œê°„**: ${{ steps.current-time.outputs.formattedTime }}
            **ì»¤ë°‹**: ${{ github.event.pull_request.head.sha }}

            ### ğŸ“Š ìš”ì•½
            - **Type Check**: ${{ steps.typecheck.outputs.typecheck_status || 'â­ï¸ ê±´ë„ˆëœ€' }}
            - **Lint**: ${{ steps.lint.outputs.lint_status || steps.skipped.outputs.lint_status || 'â­ï¸ ê±´ë„ˆëœ€' }}
            - **Tests**: ${{ steps.test.outputs.test_status || steps.skipped.outputs.test_status || 'â­ï¸ ê±´ë„ˆëœ€' }}

            ---

            ${{ steps.read-results.outputs.test_results_content }}
